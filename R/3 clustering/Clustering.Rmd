---
title: "R Markdown"
author: ""
date: "2022-12-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


<b style = 'color : DarkGoldenRod; font-size: 25px;'> **USO DEL ANÁLISIS DE AGRUPAMIENTO DE PAM PARA AGRUPAR PAÍSES POR RIQUEZA, DESARROLLO, EMISIONES DE CARBONO Y FELICIDAD**</b>

<b style = 'color : DarkRed; font-size: 25px;'> **TABLA DE CONTENIDOS SUGERIDO**</b>


1. IMPORTACIÓN DE BIBLIOTECAS

2. CARGA DE DATOS

3. LIMPIEZA DE DATOS

4. PREPROCESAMIENTO DE DATOS

5. SIEMPRE (CASI) ESCALAR LOS DATOS.

6. ANÁLISIS DE COMPONENTES PRINCIPALES (PCA)

7. USO DEL ANÁLISIS DE AGRUPAMIENTO DE PAM PARA AGRUPAR PAÍSES POR RIQUEZA, DESARROLLO, EMISIONES DE CARBONO Y FELICIDAD

8. UN MAPA MUNDIAL DE LOS CLÚSTERES

FIN


<b style = 'color : green; font-size: 25px;'> **1. - IMPORTACION DE BIBLIOTECAS**</b>


<b style = 'color : orange; font-size: 15px;'> **Importar librerias**</b>

```{r}
library(dplyr)
library(plotly)
library(stringr)
library(cluster)
library(FactoMineR)
library(factoextra)
library(ggplot2)
library(reshape2)
library(ggthemes)
library(NbClust)
library(mice)
library(DataExplorer)
library(psych) 
library(ggcorrplot)
```

<b style = 'color : green; font-size: 25px;'> **2. - CARGA DE DATOS**</b>


<b style = 'color : orange; font-size: 15px;'> *Cargando el conjunto de datos*</b>

```{r}
# importar los datos usando la libreria "xlsx"
library(xlsx)
hpi <- read.xlsx('TABLA.csv',sheetIndex = 5, header = TRUE)
```

<b style = 'color : orange; font-size: 15px;'> *Mostrar contenido del dataset*</b>

```{r}
# MOSTRAR LAS PRIMERAS FILAS
head(hpi)
```

```{r}
# MOSTRAR LAS ULTIMAS FILAS
tail(hpi)
```

<b style = 'color : blue; font-size: 12px;'> *- Se observa que hay presencia de datos faltantes tanto en filas y columnas, asi como también e información poco relevante*</b>

<b style = 'color : green; font-size: 25px;'> **3. - LIMPIEZA DE DATOS**</b>

<b style = 'color : orange; font-size: 15px;'> *identificacion y tratamiento de datos nulos*</b>

```{r}
# Mostrar la cantidad de datos nulos por cada columna
colSums(is.na(hpi))
```

```{r}
# Mostrar % de datos nulos por cada columna
porcentajeMiss <- function(x) {sum(is.na(x)) / length(x)*100}
apply(hpi, 2, porcentajeMiss)
```

<b style = 'color : blue; font-size: 12px;'> *-Se observa que desde la columna "NA..15" en adelante presentan un 100% de valores nulos, los cuales tendremos que eliminar ya que no poseen ningún dato, al igual que la columna "NA."*</b>

<b style = 'color : orange; font-size: 15px;'> *Eliminando contenido poco relevante*</b>

```{r}
# Eliminando columnas con datos nulos
hpi_temp <- hpi[,-c(1,16:42)]
head(hpi_temp)
```

<b style = 'color : blue; font-size: 12px;'>*- Observando el archivo excel se detectó que hay datos nulos e innecesarios al inicio y al final del dataset*</b>

```{r}
# Eliminando filas con datos nulos y contenido no relevante
hpi_clean <- hpi_temp[-c(1:5,146:163),]
head(hpi_clean)
```

<b style = 'color : orange; font-size: 15px;'> *Renombrando las columnas*</b>

```{r}
names(hpi_clean) <- c("HPI_Rank",	"Country", "Region",	"Average_Life_Expectancy", "Average_Wellbeing", "Happy_Life_Years",	"Footprint", "Inequality_of_Outcomes",	"Inequality_adjusted_Life_Expectancy",	"Inequality_adjusted_Wellbeing",	"Happy_Planet_Index",	 "GDP_capita",	"Population",	"GINI_index")
rownames(hpi_clean) <- NULL # resetear los indices
head(hpi_clean)
```

<b style = 'color : blue; font-size: 12px;'>*- Verificando que el dataset se encuentre libre de datos nulos*</b>


```{r}

sum(is.na(hpi_clean)) 
```

<b style = 'color : green; font-size: 25px;'> **4. - PREPROCESAMIENTO DE DATOS**</b>

<b style = 'color : orange; font-size: 15px;'> *corregir el tipo de dato de cada columna*</b>

```{r}
# Se observa que el tipo de dato en la tabla no son los correctos respecto a su contenido
hpi_clean$HPI_Rank <- as.integer(hpi_clean$HPI_Rank)
hpi_clean$Region <- as.factor(hpi_clean$Region)
hpi_clean$Average_Life_Expectancy <- as.numeric(hpi_clean$Average_Life_Expectancy)
hpi_clean$Average_Wellbeing <- as.numeric(hpi_clean$Average_Wellbeing)
hpi_clean$Happy_Life_Years <- as.numeric(hpi_clean$Happy_Life_Years)
hpi_clean$Footprint <- as.numeric(hpi_clean$Footprint)
hpi_clean$Inequality_of_Outcomes <- as.numeric(hpi_clean$Inequality_of_Outcomes)
hpi_clean$Inequality_adjusted_Life_Expectancy <- as.numeric(hpi_clean$Inequality_adjusted_Life_Expectancy)
hpi_clean$Inequality_adjusted_Wellbeing <- as.numeric(hpi_clean$Inequality_adjusted_Wellbeing)
hpi_clean$Happy_Planet_Index <- as.numeric(hpi_clean$Happy_Planet_Index)
hpi_clean$GDP_capita <- as.numeric(hpi_clean$GDP_capita)
hpi_clean$Population <- as.numeric(hpi_clean$Population)
hpi_clean$GINI_index <- as.factor(hpi_clean$GINI_index)
```

<b style = 'color : orange; font-size: 15px;'> *descripción de los datos*</b>

```{r}
str(hpi_clean)
```

<b style = 'color : orange; font-size: 15px;'> *Mostrando el resumen estadistico *</b>


```{r}
summary(hpi_clean)
```

<b style = 'color : blue; font-size: 12px;'>*- Dimensiones del dataset despues de la limpieza*</b>


```{r}
dim(hpi_clean)
```

<b style = 'color : orange; font-size: 15px;'> *Análisis y visualización de los datos*</b>

*- Graficando el primer grupo de datos*

```{r}
pairs.panels(hpi_clean[,1:6], pch=21,main="Gráfico : Matriz de Dispersión, Histograma y Correlación",bg=c("blue"))
```

<b style = 'color : blue; font-size: 12px;'>*Se observa una alta correlacion positiva con respecto a las variables "Average_life_expectancy", "Average_wellbeing" y "Happy_life_years"*</b>


*- Graficando el segundo grupo de datos*

```{r}
pairs.panels(hpi_clean[,7:13], pch=21,main="Gráfico : Matriz de Dispersión, Histograma y Correlación",bg=c("blue"))
```

<b style = 'color : blue; font-size: 12px;'>*Se observa que al relacionar algunas caracteristicas correlaciones negativas, positivas y nula*</b>


```{r}
plot_histogram(hpi_clean,ggtheme = theme_linedraw())
```

<b style = 'color : blue; font-size: 12px;'>*Se observa que algunas caracteristicas presentan distribucion de campana como "Average_wellbeing", las caracteristicas "Happy_life_years" y "life_expectancy" presentan distribucion bimodal y las caracteristicas "footprint" y "GDP_capita" presentan una distribucion asimétrica positiva*</b>

<b style = 'color : orange; font-size: 15px;'> *Busqueda de valores atípicos*</b>

```{r}
boxplot(hpi_clean[,3:13],main = "Boxplot del índice del planeta feliz 2016",
        boxwex = 0.5,col="purple")
```

<b style = 'color : blue; font-size: 12px;'>*Se observa gran cantidad de valores atipicos en la caracteristica "Population" y "GDP_capita", para lo cual se realizará el respectivo tratamiento de outliers*</b>

<b style = 'color : orange; font-size: 15px;'> *Tratamiento de outliers*</b>

```{r}
# creando copia
hpi_copy <- hpi_clean
```

```{r}
# "Population"
qrts <- quantile(hpi_copy$Population, probs = c(0.25, 0.75), na.rm = TRUE)
caps <- quantile(hpi_copy$Population, probs = c(.05, .95), na.rm = TRUE)
iqr <- qrts[2]-qrts[1]
h <- 1.5 * iqr
hpi_copy$Population[hpi_copy$Population<qrts[1]-h] <- caps[1]
hpi_copy$Population[hpi_copy$Population>qrts[2]+h] <- caps[2]
```

```{r}
# "GDP_capita"
qrts <- quantile(hpi_copy$GDP_capita, probs = c(0.25, 0.75), na.rm = TRUE)
caps <- quantile(hpi_copy$GDP_capita, probs = c(.05, .95), na.rm = TRUE)
iqr <- qrts[2]-qrts[1]
h <- 1.5 * iqr
hpi_copy$GDP_capita[hpi_copy$GDP_capita<qrts[1]-h] <- caps[1]
hpi_copy$GDP_capita[hpi_copy$GDP_capita>qrts[2]+h] <- caps[2]
```

```{r}
dim(hpi_copy)
```

<b style = 'color : blue; font-size: 12px;'>*- Se observa que no hubo perdida de datos y se redujo en gran medida los outliers*</b>


```{r}
boxplot(hpi_copy[,3:13],main = "Boxplot del índice del planeta feliz 2016",
        boxwex = 0.5,col="purple")
```


<b style = 'color : green; font-size: 25px;'> **5. - ESCALAR LOS DATOS**</b>

<b style = 'color : blue; font-size: 12px;'>*- Se procede a normalizar los datos para trabajar en una misma escala*</b>


```{r}
hpi_sin_outliers <- hpi_copy
```

```{r}
hpi_scale <- hpi_sin_outliers[, 4:13]
hpi_scale  <- scale(hpi_scale)
summary(hpi_scale)
```


<b style = 'color : orange; font-size: 15px;'> *Analisis de correlacion*</b>


```{r}
ggcorrplot(round(cor(hpi_scale), 1), type = "lower", lab = T, show.legend = T,tl.srt=45)
```

<b style = 'color : blue; font-size: 12px;'>*- Se observa una correlacion muy baja o nula respecto a las caracteristicas de "population", esto quiere decir que es una caracteristicas poco relevante para el proceso de clusterizacion ya que no aporta mucha información.*</b>

<b style = 'color : blue; font-size: 12px;'>*- La caracteristica "inequality_of_outcome" presenta una correlacion negatica fuere respecto a las otras caracteristicas, lo cual indica que cuando una de las variables aumenta, la otra variable disminuye y viceversa.*</b>


<b style = 'color : green; font-size: 25px;'> **6. - ANÁLISIS DE COMPONENTES PRINCIPALES (PCA)**</b>

```{r}
hpi_clean.pca <- PCA(hpi_scale, graph=FALSE)
print(hpi_clean.pca)
```


```{r}
fviz_screeplot(hpi_clean.pca, addlabels = TRUE, ylim = c(0, 75)) +
  theme_classic()
```

<b style = 'color : blue; font-size: 12px;'>*Según el gráfico, nos muestra que las 2 primeras dimensiones explica el 81.1% de representatividad de todo el conjunto de datos.*</b>

<b style = 'color : blue; font-size: 12px;'>*Adicionalmente las 2 primeras dimenciones retienen aproximadamente el 80% de las varianzas contenidas en el conjunto de datos.*</b>

<b style = 'color : blue; font-size: 12px;'>*Las 5 últimas componentes no superan por separado el 1% de varianza explicada.*</b>


*NOTA: El método PCA es altamente sensible a outliers*


```{r}
fviz_pca_var(hpi_clean.pca, col.var="contrib",
             repel = TRUE 
             )+scale_colour_viridis_c() 
```

<b style = 'color : blue; font-size: 12px;'>*Segun el grafico de influencias se observa que la mayoria de las variables que apuntan a la derecha tienen influencias positivas grandes en la dimension 1 y la variable "inequality_of_outcome" tiene  influencia negativa en la dimension 1 y 2 *</b>

<b style = 'color : blue; font-size: 12px;'>*Segun el grafico se observa que la variable "population presenta una ortogonalidad respecto a la mayoria de variables, lo cual quiere decir que es una variable poco relevante" *</b>


<b style = 'color : green; font-size: 25px;'> **7. - USO DEL ANÁLISIS DE AGRUPAMIENTO DE PAM **</b>

<b style = 'color : orange; font-size: 15px;'> **Estimación del número de clusters**</b>


<b style = 'color : blue; font-size: 12px;'> **Método del codo: **</b>


```{r}
set.seed(2023)
ks <- 2:10
```

```{r}
fviz_nbclust(hpi_scale, kmeans, method = "wss")+geom_vline(xintercept = 3, color = "red", linetype = 2)
```

<b style = 'color : blue; font-size: 12px;'> **Método de la silueta: **</b>


```{r}
fviz_nbclust(hpi_scale, kmeans, method = "silhouette") 
```

<b style = 'color : blue; font-size: 12px;'> **Método de la estadística de brecha **</b>


```{r}
fviz_nbclust(hpi_scale, kmeans, method = "gap_stat")
```

<b style = 'color : blue; font-size: 12px;'> *La mayoría de las técnicas aplicadas para estimar el número de clusters, sugieren que se debe agrupar en 3 clusters*</b>


<b style = 'color : orange; font-size: 15px;'> **PROPUESTA DE ANÁLISIS PAM 1:  En base a las variables solicitadas como paises por riqueza, desarrollo, emiciones de carbono y felicidad**</b>


```{r}
#hpi_scale2 = hpi_scale[, 1:3]
hpi_scale2 = hpi_scale[, c(1,2,3,8)]
```


```{r}
set.seed(2023)
pam <- pam(hpi_scale2, diss=FALSE, k = 3, keep.data=TRUE)
```

```{r}
hpi_clean$Country[pam$id.med]
```

```{r}
fviz_cluster(pam, stand = FALSE, geom = "point",
             ellipse.type = "norm", ggtheme = theme_classic())
```

<b style = 'color : orange; font-size: 15px;'> **EVALUACION DE ALGORIRMO PAM PROPUESTA 1 *</b>

```{r}
fviz_silhouette(pam)
```


<b style = 'color : orange; font-size: 15px;'> **PROPUESTA DE ANÁLISIS PAM 2:  En base a la sugerencia de la técnica de PCA**</b>

<b style = 'blue : orange; font-size: 12px;'> *Haciendo uso de las variables con mayor representatividad*</b>

```{r}
hpi_scale2 = hpi_scale[, 1:3]
```


```{r}
set.seed(2023)
pam <- pam(hpi_scale2, diss=FALSE, k = 3, keep.data=TRUE)
```

```{r}
hpi_clean$Country[pam$id.med]
```

```{r}
fviz_cluster(pam, stand = FALSE, geom = "point",
             ellipse.type = "norm", ggtheme = theme_classic())
```

```{r}
library(plotly)
```

```{r}
hpi_clean['Cluster'] <- as.factor(pam$clustering)
```

```{r}
plot_ly(hpi_clean, x = ~Average_Life_Expectancy, y = ~Average_Wellbeing, z = ~Happy_Life_Years) %>%
  add_markers(color = ~Cluster)
```


<b style = 'color : orange; font-size: 15px;'> *EVALUACION DE ALGORIRMO PAM PROPUESTA 2*</b>

```{r}
fviz_silhouette(pam)
```

<b style = 'color : blue; font-size: 15px;'> *Respecto a los resultados obtenidos en las evaluaciones, se observa que para la propuesta 1 se obtuvo valores de (0.48, 0.31, 0.40) para cada cluster respectivamente con un promedio final de 0.38, sin embargo, para la propuesta 2 con PCA se obtuvo valores de (0.50, 0.43, 0.51) para cada cluster respectivamente con un promedio final de 0.48*</b>

<b style = 'color : blue; font-size: 15px;'> *Esto quiere decir que aplicando la tecnica de PCA el agrupamiento mejora significativamente, ya que reduce variables que aportan poca informacion o irrelevantes*</b>


<b style = 'color : orange; font-size: 12px;'> *EXTRAYENDO INFORMACIÓN DEL CLUSTER 1*</b>

```{r}
cluster1 <- hpi_clean[hpi_clean$Cluster == 1,]
cluster1 <- cluster1[, c("Country", "Average_Life_Expectancy", "Average_Wellbeing", "Footprint", "Happy_Planet_Index", "GDP_capita")]
cluster1$Country
```
```{r}
summary(cluster1[, c(2:6)])
```

<b style = 'color : green; font-size: 12px;'> *EXTRAYENDO INFORMACIÓN DEL CLUSTER 2*</b>

```{r}
cluster2 <- hpi_clean[hpi_clean$Cluster == 2,]
cluster2 <- cluster2[, c("Country", "Average_Life_Expectancy", "Average_Wellbeing", "Footprint", "Happy_Planet_Index", "GDP_capita")]
cluster2$Country
```
```{r}
summary(cluster2[, c(2:6)])
```


<b style = 'color : blue; font-size: 12px;'> *EXTRAYENDO INFORMACIÓN DEL CLUSTER 3*</b>

```{r}
cluster3 <- hpi_clean[hpi_clean$Cluster == 3,]
cluster3 <- cluster3[, c("Country", "Average_Life_Expectancy", "Average_Wellbeing", "Footprint", "Happy_Planet_Index", "GDP_capita")]
cluster3$Country
```
```{r}
summary(cluster3[, c(2:6)])
```


<b style = 'color : green; font-size: 25px;'> **8. - UN MAPA MUNDIAL DE LOS CLÚSTERES**</b>

```{r}
map <- map_data("world")
```

```{r}
map$region[map$region == "USA"] <- "United States of America"
map1 <- left_join(map, hpi_clean[, c("Region", "Country",	"Average_Life_Expectancy", "Average_Wellbeing", "Footprint", "Inequality_of_Outcomes",		"Happy_Planet_Index",	 "GDP_capita",	"Population", "Cluster")], by = c("region" = "Country"))
```

```{r}
HPI_map <- ggplot(map1) + 
  geom_polygon(aes(x = long, y = lat, group = group, fill = Cluster, colour = Cluster)) +
  coord_equal() +
  labs(title = "Agrupación Índice Planeta Feliz", subtitle = "", x = NULL, y = NULL) +
  theme_linedraw() +
  theme(plot.title = element_text(face = "bold"), plot.subtitle = element_text(face = "italic"),
        legend.position = "bottom", legend.justification = "center", 
        legend.title = element_text(face = "bold"),
        )

HPI_map
```



<b style = 'color : orange; font-size: 15px;'> *Cluster 1 (bajo): Este grupo lo conforman la mayoria de los paises del continente africano, donde el PBI medio es de 1754.3, con una puntuacion de bienestar de 4.269, una esperanza de vida de 59.78 años, con emisiones de carbono de 1.419 y adicionalmente la felicidad tiene una puntuacion de 20.41 *</b>


<b style = 'color : green; font-size: 15px;'> *Cluster 2 (medio): Este grupo lo conforman algunos paises de America del sur como Perú, Guatemala, paises de Asia y paises pertenecientes al continente Europeo, donde el PBI medio es de 7545.4, con una puntuacion de bienestar de 5.318, una esperanza de vida de 73.22 años, con emisiones de carbono de 3.159 y adicionalmente la felicidad tiene una puntuacion de 28.22*</b>


<b style = 'color : blue; font-size: 15px;'> *Cluster 3 (alto): Este grupo lo conforman paises de America del norte y algunos de America del sur como Brazil, Chile, tambien lo conforman paises del continente de Oceania y algunos paises de Europa, donde el PBI medio es de 39057, con una puntuacion de bienestar de 6.892, una esperanza de vida de 79.98 años, con emisiones de carbono de 5.572 y adicionalmente la felicidad tiene una puntuacion de 30.30*</b>

<b style = 'color : grey; font-size: 15px;'> *Otros: representado por el color gris(no se tiene información)*</b>


```{r}

#rstudioapi::applyTheme("Material Palenight {rsthemes}")
rstudioapi::applyTheme("Night Owl {rsthemes}")
```






```{r}
# Obtener la moda de dicha columna
mode <- function(x) {
   return(as.numeric(names(which.max(table(x)))))
}
moda_Nucleos_desnudos = mode(dataset_cancer$Nucleos_desnudos)
moda_Nucleos_desnudos
```




```{r}
# Tratamiento de caracter extraño
dataset_cancer$Nucleos_desnudos[dataset_cancer$Nucleos_desnudos=="?"] <- moda_Nucleos_desnudos

# corregir el tipo de dato de dicha columna "Nucleos_desnudos"
dataset_cancer$Nucleos_desnudos<- as.integer(dataset_cancer$Nucleos_desnudos)

# corregir el tipo de dato de la columna "clase"
dataset_cancer$Clases<- as.factor(dataset_cancer$Clases)
```




